# 基本設計書（QIC）

## 1. 目的

Qiita記事の本文中に含まれる画像を対象に、ローカルへ取得→（必要に応じて）最適化→Qiitaへ再アップロード→本文中の画像URLを差し替え→記事を更新する。

安全性のため、**URL差し替え以外の本文変更が発生していないことを検証**し、検証NGの場合は更新を中止する。

## 2. 全体構成

- **CLI層**: `src/cli.js`
  - オプションの受け取り、`runQic()` の起動
- **アプリ層（オーケストレーション）**: `src/qic.js`
  - 記事本文の取得（編集画面から）、画像抽出、ダウンロード、最適化、アップロード、URL差し替え、更新、削除（任意）
- **UI自動化層（Qiita）**: `src/qiitaUi.js`
  - Playwrightで編集画面を操作（ログイン待ち/本文取得/画像アップロード/更新）
- **削除UI自動化層**: `src/qiitaUploadedFilesUi.js`
  - `/settings/uploaded_images` をページングし、対象UUIDの削除を実行（ベストエフォート）
- **画像処理**: `src/images.js`
  - 画像ダウンロード、目標サイズへ最適化（可読性優先の段階的縮小）
- **本文処理**: `src/text.js`
  - 画像URL抽出、URL置換（文字列置換）
- **安全チェック**: `src/diffCheck.js`
  - 「URL置換以外の差分が無い」ことを検証
- **URLユーティリティ**: `src/qiitaUrl.js`
  - item_id抽出、編集URL生成
- **ロガー**: `src/logger.js`
  - コンソール + ファイル出力、構造化ログ

## 3. 処理フロー（概要）

1. CLIでURL/オプションを受け取る
2. Playwrightを起動し、編集URLへ遷移
3. ログイン完了・編集画面の準備完了を待つ
4. 編集画面から本文Markdownを取得し、`out/backups/` に保存
5. 本文から画像URLを抽出
6. `--scope` に従い対象画像を決定
   - `all`: 許容上限を超える画像のみ
   - `single`: 許容上限を超える最初の1枚のみ
7. 対象画像をローカルへダウンロードし、必要に応じて最適化
8. 編集画面へアップロードし、アップロード後URLを取得
9. 本文中の画像URLを差し替える（エディタ内置換）
10. 差し替え後本文が期待通りか安全チェック（URL差分のみ）を実行
11. `--dry-run` でなければ更新ボタンを押下
12. 更新後に公開ページ側でURL反映を確認
13. `--delete-original` の場合、`/settings/uploaded_images` から元画像を削除（ベストエフォート）

## 4. 入出力と成果物

- **入力**
  - Qiita記事URL
  - CLIオプション（`--scope`, `--target-kb`, `--storage-state`, `--dry-run`, `--delete-original` など）
- **出力**
  - 更新済み記事（UI経由）
  - ローカル成果物（`--out` 配下）
    - `out/originals/`: 取得した元画像
    - `out/optimized/`: 最適化後画像
    - `out/backups/`: 本文バックアップ
    - `out/logs/`: 実行ログ
    - `out/artifacts/`: 失敗時のスクリーンショット/trace/差分

## 5. エラー処理方針

- **本文安全チェック NG**: 更新ボタンを押さず中止し、差分を `out/artifacts/` へ出力
- **画像ダウンロードがAccessDenied**: その画像は処理対象外としてスキップ（URLも変更しない）
- **UI自動化の失敗**: タイムアウト/例外時に `out/artifacts/` に解析情報を出す（trace/HTML/screenshot）

## 6. 非機能要件（要点）

- **観測可能性**: フェーズログ（`PHASE:`）と、待機時の進捗ログ（ハートビート）を出す
- **安全性**: URL差し替え以外の本文変更は許容しない
- **保守性**: UI変更の影響が大きい箇所はログ/成果物を厚めにする

