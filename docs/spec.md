# QIC（Qiita Image Collector/Compressor）仕様書

## 1. 目的

指定された **Qiita 記事URL** を入力として、記事内の画像を取得・最適化（概ね 500KB 付近）し、（再アップロード先へ）アップロードした画像URLへ差し替えたうえで、記事本文を更新する。

本仕様書は「まず動くものを作る」ために、**Qiita公式APIで可能な範囲**と、**公式APIだけでは不明/不可能な範囲**（画像アップロード）を分離して定義する。

## 2. 前提・用語

- **Qiita記事URL**: `https://qiita.com/<user>/items/<item_id>` 形式を主対象とする。
  - `item_id` は URL パスから抽出できる前提。
- **giita**: ご要望中の「giita」は表記ゆれと解釈し、以降は **Qiita** を指すものとして記載する。
  - もし「Qiita以外の別サービス（社内giita等）」を指す場合、本仕様書の「アップロード先」を差し替える。
- **画像**: 記事本文（Markdown）内で参照される画像URL、および HTML 埋め込み（`<img src="...">`）を対象。

## 3. 仕様の全体像（処理フロー）

1. **入力URL解析**
   - Qiita記事URLから `item_id` を抽出する。
2. **記事本文取得**
   - Qiita API v2 から当該記事の本文（Markdown）を取得する。
3. **画像URL抽出**
   - Markdown本文から画像URLを抽出する（`![]()` / `<img>` 等）。
4. **画像ダウンロード**
   - 抽出した画像をローカルへ保存する（オリジナル）。
5. **画像最適化（目標: 500KB 前後）**
   - 画像を再エンコード（品質調整＋必要に応じてリサイズ）し、概ね 500KB に近づける。
6. **画像アップロード（方式選択）**
   - Qiita公式APIでの画像アップロード手段が不明/提供されない可能性があるため、以下の方式を選択可能とする（後述）。
7. **本文の画像URL差し替え**
   - オリジナルURL → アップロード後URLへ置換した Markdown を生成する。
8. **記事更新**
   - Qiita API v2 の記事更新APIで本文を更新する（上書き）。

## 4. Qiita API（一次情報として確認できた点）

### 4.0 認証とベースURL

- **ベースURL**: `https://qiita.com`
- **認証**: `Authorization: Bearer <QIITA_ACCESS_TOKEN>` をHTTPヘッダに付与して呼び出す。

本アプリはアクセストークンを環境変数 `QIITA_ACCESS_TOKEN` から読み込む。

### 4.0.1 記事取得API（GET）

Qiita API v2 ドキュメントに **`GET /api/v2/item/:item_id`**（Get an item）が存在する。

本アプリは以下を取得し、更新時に再利用する。

- `title`（更新時に必須）
- `body`（画像URL抽出・置換対象）
- 可能なら `tags` 等（「差し替え以外の内容を変えない」ため）

### 4.1 記事更新API（PATCH）

Qiita API v2 ドキュメントに **`PATCH /api/v2/item/:item_id`**（Update an item）が存在し、リクエストボディとして **`title` と `body` が required** と記載されている。

- **必須**: `title`（記事タイトル）, `body`（Markdown本文）
- **任意**: `tags`, `private`, `coediting`, `group_url_name`, `organization_url_name` 等

このため本アプリは「本文だけ差し替え」ではなく、**更新時に title も取得して再送**する（title を失わないため）。

### 4.2 画像アップロードAPI

Qiita API v2 ドキュメント内に、画像アップロードを直接行う `POST /api/v2/...image...` のようなエンドポイントが見当たらない（少なくとも本仕様策定時点の確認範囲）。

一方でドキュメントには、ユーザ情報等のフィールドとして **月間画像アップロード容量に関する情報**（例: `image_monthly_upload_limit`, `image_monthly_upload_remaining`）が存在し、画像アップロードという概念自体は API モデル上に現れている。

よって、画像の再アップロードは **Qiita公式API以外の手段**を必要とする可能性が高い。

## 5. 画像アップロード方式（採用: 方式B）

本アプリは、アップロード部分を「プロバイダ」として差し替え可能にする。

### 方式B: ブラウザ自動化（Playwright 等）【採用】

- **概要**: Qiitaの編集画面を自動操作して画像をアップロードし、生成された画像URLを取得して本文に反映する。
- **狙い**: 画像をQiita内（Qiita画像アップロード機能）に置いたまま、URL差し替えと記事更新まで自動化する。
- **利点**: Qiita内の画像管理・表示最適化の恩恵を受けられる。
- **欠点**: UI変更に弱い、認証情報管理が難しい、利用規約・運用ポリシーとの整合確認が必要。

#### 方式Bの詳細仕様（Playwright）

- **ログイン方法**
  - 起動時に `--headed` でブラウザを起動し、ユーザーが **手動でQiitaへログイン**する。
  - アプリはログイン完了を検知するまで待機し、完了後に自動処理を継続する。
    - 検知条件（例）: 「編集ページにアクセス可能」または「ヘッダにユーザーアイコンが表示される」など。
  - 2FA / CAPTCHA 等がある場合も、この「起動時手動ログイン」手順で対応する。
  - （オプション）ログイン後のセッションを **Playwright `storageState`** としてローカルに保存し、次回以降 `--headless` 実行を可能にする（例: `./.secrets/qiita-storage-state.json`）。
- **記事編集画面への遷移**
  - 対象記事URLから編集ページ（`/items/<item_id>/edit`）へ遷移する。
- **画像アップロード**
  - 編集画面のエディタ領域へ画像をドラッグ&ドロップ、または「画像追加」ボタンからファイル選択でアップロードする。
  - アップロード後に挿入される Markdown（例: `![](https://qiita-image-store...)`）を取得し、**アップロード前URL→アップロード後URL** の対応表を作る。
  - URL取得は以下を優先:
    - エディタのテキスト差分から挿入されたURLを抽出
    - 併用: ネットワークリクエスト監視（XHR/fetch）からレスポンスに含まれるURLを抽出（UI変更耐性を高めるために二重化）
- **本文更新**
  - 方式B採用時は、記事更新は原則 **編集画面で「更新」ボタンを押下**して行う（Qiita APIトークンが不要になる）。
  - ただし、将来の拡張として Qiita API v2 によるPATCH更新も残す（オプション）。

### 方式C: 半自動（ローカル生成のみ）

- **概要**: 最適化済み画像と置換後Markdownを生成し、アップロード・本文反映は人手で行う。
- **利点**: 最小リスクで導入できる。
- **欠点**: 手作業が残る。

本仕様の第一段階では **方式B** を標準とし、方式Cはオプション扱いとする。

## 6. 画像取得仕様

### 6.1 抽出対象

- Markdown画像: `![alt](https://...)`
- HTML埋め込み: `<img src="https://...">`
- 追加で将来対応:
  - `<picture>` / `srcset` / 相対URL

### 6.2 重複排除

- 同一URLは1回だけダウンロード/変換する。
- 差し替えは本文中の出現箇所すべてに適用する。

## 7. 画像最適化仕様（約500KB）

### 7.1 目標

- **目標サイズ**: 500KB（= 512000 bytes）をデフォルトとする。
- 許容誤差は実装都合で±10%程度を許容（オプションで変更可能）。

### 7.2 変換ルール（初期案）

- **JPEG/WEBP/AVIF/PNG**:
  - まず「品質（quality）」を下げて目標サイズへ近づける。
  - それでも大きい場合、段階的にリサイズ（例: 長辺を 90%→80%…）を併用する。
- **GIF**:
  - 初期は「変換対象外（そのままコピー）」とし、将来最適化に対応。

### 7.3 実装方針（sharp想定）

- 反復（例: 二分探索）で quality を決定し、目標サイズに近いエンコード結果を採用する。
- 画像の透明度がある場合、既定出力形式は **WEBP**（透過対応）を推奨し、オプションで変更可能とする。

## 8. 本文URL差し替え仕様

- 「抽出した元URL → アップロード後URL」の対応表（Map）を作り、本文を置換する。
- 置換対象は以下を優先:
  - Markdownの `(...)` 内URL
  - HTMLの `src="..."` 内URL
- 置換は **完全一致** を基本とし、クエリ付きURL等は正規化ポリシー（後述）に従う。

## 9. 設定・認証

### 9.1 Qiita APIトークン

- （オプション）環境変数: `QIITA_ACCESS_TOKEN`
- ログにトークンを出さない。
- **方式B（Playwright）でUI更新まで行う場合、必須ではない。**

### 9.2 アップロードプロバイダ別設定（例）

- Playwright:
  - `QIC_STORAGE_STATE_PATH`（例: `./.secrets/qiita-storage-state.json`）
  - `QIC_HEADLESS`（既定: `false`。起動時に手動ログインするため。）

## 10. CLI仕様（提案）

### 10.1 コマンド

- `qic run <qiitaArticleUrl>`

### 10.2 主なオプション

- `--target-kb <number>`: 目標サイズ（既定: 500）
- `--out <dir>`: 出力ディレクトリ（既定: `./out`）
- `--upload-provider <none|playwright>`（既定: `playwright`）
- `--dry-run`: 記事更新を行わず、差し替え後Markdownの生成までで止める
- `--concurrency <n>`: ダウンロード/変換の並列数
- `--storage-state <path>`: Playwrightの `storageState` ファイルパス
- `--headed`: ブラウザを表示して実行（既定。起動時の手動ログイン用）
- `--headless`: ブラウザ非表示で実行（`--storage-state` が有効な場合のみ推奨）

## 11. ログ・エラーハンドリング

- 進捗ログ:
  - 画像検出数、DL成功/失敗数、最適化結果（元サイズ→新サイズ）、アップロードURL
- 代表エラー:
  - Qiita API認証失敗（401）
  - 記事URL形式不正 / item_id 抽出失敗
  - 画像ダウンロード失敗（404/タイムアウト）
  - 画像変換失敗（形式不正）
  - アップロード失敗（プロバイダ依存）
  - 記事更新失敗（権限不足、必須項目不足）

## 12. セキュリティ・運用上の注意

- Qiitaの利用規約・レート制限に配慮し、過度な並列リクエストを避ける。
- 画像の著作権・再配布可否は利用者が確認する。
- ブラウザ自動化方式（方式B）を採用する場合は、利用規約・社内ポリシー確認を必須とする。

## 13. 未確定事項（要確認）

- 「giita」が Qiita 以外のサービスを指すか。
- 記事の取得を HTML 解析で行うか、Qiita API v2（推奨）で行うかの確定。
- 画像URLの正規化（クエリ付きURL、リサイズ派生URL等）の扱い。
- GIF/動画/図表（SVG等）の扱い。

